---
- name: Set vm.max_map_count for SonarQube (required by Elasticsearch)
  sysctl:
    name: vm.max_map_count
    value: '262144'
    state: present
    reload: yes

- name: Set fs.file-max for SonarQube
  sysctl:
    name: fs.file-max
    value: '65536'
    state: present
    reload: yes

- name: Create SonarQube directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: '0755'
  loop:
    - /opt/sonarqube
    - /opt/sonarqube/data
    - /opt/sonarqube/logs
    - /opt/sonarqube/extensions

- name: Deploy PostgreSQL for SonarQube
  community.docker.docker_container:
    name: sonarqube-db
    image: postgres:13
    state: started
    restart_policy: unless-stopped
    env:
      POSTGRES_USER: sonar
      POSTGRES_PASSWORD: sonar
      POSTGRES_DB: sonarqube
    volumes:
      - /opt/sonarqube/postgresql:/var/lib/postgresql/data

- name: Wait for PostgreSQL to be ready
  wait_for:
    timeout: 30

- name: Deploy SonarQube container
  community.docker.docker_container:
    name: sonarqube
    image: sonarqube:lts-community
    state: started
    restart_policy: unless-stopped
    ports:
      - "9001:9000"
    volumes:
      - /opt/sonarqube/data:/opt/sonarqube/data
      - /opt/sonarqube/logs:/opt/sonarqube/logs
      - /opt/sonarqube/extensions:/opt/sonarqube/extensions
    env:
      SONAR_JDBC_URL: "jdbc:postgresql://sonarqube-db:5432/sonarqube"
      SONAR_JDBC_USERNAME: "sonar"
      SONAR_JDBC_PASSWORD: "sonar"
    links:
      - sonarqube-db:db

- name: Wait for SonarQube to start
  wait_for:
    port: 9000
    delay: 30
    timeout: 600

- name: Create Nginx configuration for SonarQube
  template:
    src: sonarqube.conf.j2
    dest: /etc/nginx/sites-available/sonarqube
    mode: '0644'
  notify: reload nginx

- name: Enable SonarQube Nginx site
  file:
    src: /etc/nginx/sites-available/sonarqube
    dest: /etc/nginx/sites-enabled/sonarqube
    state: link
  notify: reload nginx

- name: Display SonarQube default credentials
  debug:
    msg: "SonarQube default credentials - Username: admin, Password: admin (change on first login)"